package com.dipu.ecommerce.product.service.impl;

import java.io.File;
import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.util.List;
import java.util.UUID;

import org.springframework.data.domain.Page;
import org.springframework.data.domain.PageRequest;
import org.springframework.data.domain.Pageable;
import org.springframework.data.domain.Sort;
import org.springframework.stereotype.Service;
import org.springframework.web.multipart.MultipartFile;

import com.dipu.ecommerce.product.ProductServiceApplication;
import com.dipu.ecommerce.product.dto.ProductDto;
import com.dipu.ecommerce.product.entities.Category;
import com.dipu.ecommerce.product.entities.Product;
import com.dipu.ecommerce.product.mapper.ProductMapper;
import com.dipu.ecommerce.product.repositories.ProductRepository;
import com.dipu.ecommerce.product.service.ProductService;

import lombok.RequiredArgsConstructor;

@Service // iske through Spring ko business class pata chalta hai
@RequiredArgsConstructor // It's  used for Dependency injection
public class ProductServiceImpl implements ProductService{

	private final ProductServiceApplication productServiceApplication;
	private final ProductRepository productRepository;
	private final ProductMapper productMapper;
	private final String uploadDir = 
			System.getProperty("user.dir")+"/uploads/products/";
	
	@Override
	public ProductDto createProduct(ProductDto dto) {
		// To set Category
		Category category = null;
		if(dto.getCategoryId() != null) {
			category = new Category();
			category.setCategoryId(dto.getCategoryId());
		}
		// to covert Dto to entity and save it
		Product product = productMapper.toEntity(dto, category);
		Product save = productRepository.save(product);
		return productMapper.toDto(save);
	}

	@Override
	public ProductDto updateProduct(Long id, ProductDto dto) {
		Product product = productRepository.findById(id).
		orElseThrow(()-> new RuntimeException("Product is not found "));
		
		product.setProductName(dto.getProductName());
		product.setDescription(dto.getDescription());
		product.setPrice(dto.getPrice());
		product.setDiscountPrice(dto.getDiscountPrice());
		
		// to check in dto ,Category is available or not
		if(dto.getCategoryId() != null) {
			Category category = new Category();
			category.setCategoryId(dto.getCategoryId());
			product.setCategory(category);
		}
		return productMapper.toDto(productRepository.save(product));
	}

	@Override
	public void deleteProduct(Long id) {
		productRepository.deleteById(id);
		
	}

	@Override
	public ProductDto getProductById(Long id) {
		Product product = productRepository.findById(id).orElseThrow(()-> new RuntimeException("Product Not Found"));
		return productMapper.toDto(product);
	}

	@Override
	public Page<ProductDto> getAllProduct(int page, int size, String sortBy, String sortDir) {
		Sort sort  = sortDir.equalsIgnoreCase("asc")? Sort.by(sortBy).ascending():
			Sort.by(sortBy).descending();
		
		// to Set Pageable object which needs PageSize and PageNumber
		Pageable pageable = PageRequest.of(page, size,sort);
		Page<Product> productPage = productRepository.findAll(pageable);
		return productPage.map(productMapper::toDto);
	}

	@Override
	public Page<ProductDto> searchProduct(String keyword, int page, int size) {
		Pageable pageable = PageRequest.of(page, size);
		Page<Product> searchProductsByPage = productRepository.searchProducts(keyword, pageable);
		return searchProductsByPage.map(productMapper::toDto);
	}

	@Override
	public Page<ProductDto> filterProducts(Long categoryId, Double minPrice, Double maxPrice, int page, int size) {
		Pageable pageable = PageRequest.of(page, size);
		Page<Product> productPage =  productRepository.advanceFilter(null, categoryId, minPrice, maxPrice, pageable);
		return productPage.map(productMapper::toDto);
	}

	@Override
	public Page<ProductDto> advanceFilter(String keyword, Long categoryId, Double minPrice, Double maxPrice, int Page,
			int size, String sortBy, String sortDir) {
		// TODO Auto-generated method stub
		return null;
	}

	@Override
	public ProductDto uploadImage(Long productId, MultipartFile file) throws IOException{
		Product product = productRepository.findById(productId)
		 .orElseThrow(()-> new RuntimeException("Product Not Found ..."));
		
		if(file.isEmpty()) {
			throw new RuntimeException("Image File is Empty...");
		}
		long maxSize = 2*1024*1024;
	     
		if(file.getSize() > maxSize) {
			throw new RuntimeException("File Size less than 2 MB...");
		}
		List<String> allowedType = List.of("image/jpeg", "image/png", "image/jpg");
		
		if(!allowedType.contains(file.getContentType())) {
			throw new RuntimeException("Only jpeg , png and jpg are allowed ");
		}
		
		String originalFilename = file.getOriginalFilename();
		
		if(originalFilename == null || !originalFilename.contains(".")) {
			throw new RuntimeException("Invalid File Name ...");

		};
		String extension = originalFilename
				.substring(originalFilename.lastIndexOf(".")+1).toLowerCase();
		
		List<String> allowedExtension = List.of("jpg", "png", "jpeg");
		if(!allowedExtension.contains(extension)) {
			throw new RuntimeException("Invalid Image Extension...");
		}
		
		File folder = new File(uploadDir);
		if(!folder.exists()) {
			folder.mkdir();
		}
		String fileName = UUID.randomUUID().toString();
	
		Path filePath = Paths.get(uploadDir+fileName);
		
		Files.write(filePath, file.getBytes());
		
		String imageUrl = "/products/images/"+fileName;
		
		// this url to save in DB
		product.setImageurl(imageUrl);
		
		Product saved = productRepository.save(product);
		
		
		return productMapper.toDto(product);

	}

}
